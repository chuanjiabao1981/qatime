<div class="file-con">
  <div class="file-con-msg">
    <div style="width:480px; height: 300px; overflow: hidden; float:left;">
      <%= image_tag @course.publicize_url, id: 'course_publicize_preview3' %>
    </div>

    <div class="file-new">
      <span>*</span>
      <a href="###" data-toggle="modal" data-target="#edit_publicize">点此更换图片</a>

      <%= f.error :publicize, id: 'course_publicize_error' %>
      <p class="create-advice">
        建议：<br>
        图片像素480*300，<br>
        图片格式jpeg或png,<br>
        图片文件不大于500k,<br>
        禁止使用非法图片作为海报!
      </p>
    </div>
  </div>
</div>
<div class="editor-msg">
  <div class="row">
    <div class="col-md-2">
      <%= f.label :name %>
    </div>
    <div class="col-md-10">
      <%= f.input :name, label: false, placeholder: '请输入辅导班名称（最多20字）', input_html: {maxlength: 20} %>
    </div>
  </div>

  <div class="row">
    <div class="col-md-2">
      <%= f.label :description %>
    </div>
    <div class="col-md-10">
      <%= f.input :description, as: :text, label: false, placeholder: '请输入辅导班介绍（最多300字）', input_html: {min: 70, max: 300, rows: 5} %>
    </div>

  </div>

  <div class="row">
    <div class="col-md-2">
      <%= f.label :grade %>
    </div>
    <div class="col-md-10">
      <%= f.input :grade, collection: APP_CONSTANT['grades_in_menu'], label: false, prompt: '请选择年级' %>
    </div>
  </div>
  <%= content_tag(:div, class: 'row') do%>
    <div class="col-md-2">
      <%= f.label :workstation, style: 'margin-left: 15px;' %>
    </div>
    <div class="col-md-10">
      <%= f.association :workstation, collection: @teacher.city.workstations.map{|ws| [ws.name, ws.id]}, label: false, prompt: false%>
    </div>
  <% end if @course.invitation.blank? && @teacher.city.workstations.count > 1%>

  <div class="row">
    <div class="col-md-2">
      <%= f.label :price %>
    </div>
    <div class="col-md-10">
      <%= f.input :price, label: false, placeholder: '请输入正整数'%>
    </div>
  </div>

  <div class="row">
    <div class="col-md-2">
      <%= f.label :taste_count, class: 'listen' %>
    </div>
    <div class="col-md-10">
      <%= f.input :taste_count, label: false, placeholder: '请选择允许试听的课程数量（正整数）,不选择默认为0', input_html: {min: 0} %>
    </div>
  </div>
</div>

<!-- edit publicize Modal -->
<div class="modal fade" id="edit_publicize" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel"><%= t("view.course_show.edit_publicize_title") %></h4>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-7">
            <div class="modal-img">
              <img id="course_publicize_preview">
            </div>
          </div>
          <div class="col-md-5">
            <div class="modal-avatar" >
              <img id="course_publicize_preview2" >
            </div>
            <p>
              <% %w[x y w h].each do |attribute| %>
                <%= f.hidden_field "crop_#{attribute}"%>
              <% end %>
              <%= f.input :publicize, label: false, input_html:{onchange:"showimagepreviewarea(this)", style: "display:none;"} %>
            </p>
            <p>
              <button type="button" class="btn btn-default" id="select_avatar_btn"><%= t "teachers.common.select" %></button>
            </p>
            <p>
              <%= link_to t("view.play.close"),'javascript:void(0)','data-dismiss': "modal", class: "btn btn-default",'aria-label': "Close" %>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  var jcrop_api, boundx, boundy;

  function showimagepreviewarea(input) {
    var previewHeight = 240;
    var previewWidth = 240;

    // 初始化图片区域样式
    // 防止上一次选择的图片影响本次样式
    $("#course_publicize_preview").css({
      width: '',
      height: ''
    }).parent().css({
      paddingLeft: "0px",
      paddingTop: "0px"
    });

    if (input.files && input.files[0]) {
      var filerdr = new FileReader();
      var heightMin = previewHeight;
      var widthMin = previewWidth;
      filerdr.onload = function(e) {
        // 替换图片地址
        $('#course_publicize_preview').attr('src', e.target.result);
        $("#course_publicize_preview2").attr('src', e.target.result);
        $("#course_publicize_preview3").attr('src', e.target.result);

        // 插入图片显示尺寸
        var imgWidth = $('#course_publicize_preview').width();
        var imgHeight = $('#course_publicize_preview').height();
        boundx = imgWidth;
        boundy = imgHeight;

        // 调整图片位置使图片居中显示
        if(imgHeight > imgWidth) { // 高度大于宽度左右居中显示
          $('#course_publicize_preview').parent().css({
            paddingLeft: Math.round((previewWidth - imgWidth) / 2) + 'px',
            paddingTop: "0px"
          });
          widthMin = imgWidth;
        } else { // 高度小于宽度上下居中显示
          $('#course_publicize_preview').parent().css({
            paddingTop: Math.round((previewHeight - imgHeight) / 2) + 'px',
            paddingLeft: "0px"
          });
          heightMin = imgHeight;
        }
      }
      if (jcrop_api){
        jcrop_api.destroy();
      }
      filerdr.readAsDataURL(input.files[0]);

      // 图片加载完成以后显示默认裁剪
      filerdr.onloadend = function(e){
        $('#course_publicize_preview').Jcrop({
          bgFade:     true,
          bgOpacity: .4,
          aspectRatio: 1.6,
          setSelect: [ 0, 0, widthMin, heightMin],
          onSelect: selectCoords,
          onChange: selectCoords,
          keySupport : false
        }, function(){
          var bounds = this.getBounds();
          boundx = bounds[0];
          boundy = bounds[1];
          jcrop_api = this;
        });
      }
    }
  }

  function selectCoords(coords) {
    if (parseInt(coords.w) > 0) {
      var rx = 205 / coords.w;
      var ry = 128 / coords.h;
      var zx = 480 / coords.w;
      var zy = 300 / coords.h;

      $('#course_publicize_preview2').css({
        width : Math.round(rx * boundx) + 'px',
        height : Math.round(ry * boundy) + 'px',
        marginLeft : '-' + Math.round(rx * coords.x) + 'px',
        marginTop : '-' + Math.round(ry * coords.y) + 'px'
      });

      $('#course_publicize_preview3').css({
        width : Math.round(zx * boundx) + 'px',
        height : Math.round(zy * boundy) + 'px',
        marginLeft : '-' + Math.round(zx * coords.x) + 'px',
        marginTop : '-' + Math.round(zy * coords.y) + 'px'
      });
    }

    $('#course_crop_x').val(parseInt(coords.x) * 2);
    $('#course_crop_y').val(parseInt(coords.y) * 2);
    $('#course_crop_w').val(parseInt(coords.w) * 2);
    $('#course_crop_h').val(parseInt(coords.h) * 2);
  }

  $(function  () {
    var flag = true;
    $(".pull-down,.pull-down-input").click(function  () {
      if (flag) {
        $(".grade-check").slideDown(200);
      }else{
        $(".grade-check").slideUp(200);
      }
      flag = !flag;
    })

    $("input[name='radio']").click(function  () {
      if($("input[name='radio']").is(":checked")){
        $("input[name='course[grade]']").val($(this).val());
        $("input[name='radio']").parents(".grade-check").slideUp(200);
      }
      flag = true;
    })

    $("#select_avatar_btn").on('click',function(event){
      $("#course_publicize").click()
    })

    $("button.close").on('click',function(event){
      $("#course_publicize").value = ''
      $('#course_publicize_preview').attr('src', '');
      $("#course_publicize_preview2").attr('src', '');

      $('#course_publicize_preview').parent().css({
        paddingTop: '0px'
      });
      $('#course_publicize_preview').css({
        height: 'auto',
        width: '100%'
      });
      $("#course_publicize_preview2").css({
        height: '128px',
        width: '205px',
        marginTop: '0px',
        marginLeft: '0px'
      })

      if (jcrop_api){
        jcrop_api.destroy();
      }
    })
  })

</script>