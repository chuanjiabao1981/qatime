<div class="live-message">
  <div class="message-title">
    <%= link_to t("view.play.talk"), "javascript:void(0);", class: "active" %>
    <%= link_to t("view.play.announcement"), "javascript:void(0);" %>
    <%= link_to t("view.play.members"), "javascript:void(0);" %>
  </div>
  <div class="message-content">
    <div class="message-con active">
      <div class="message-new" id="messages">
      </div>

      <div class="information-face">
        <%= image_tag 'face-2.png', id: "emotion-btn" %>
        <%= image_tag 'face-1.png', id: "clear-btn" %>
        <%= link_to t("view.play.chat_history"), "javascript: void(0);", id: "history-btn",
                    "data-toggle" => "modal", "data-target" => "#history-modal", style: "float: right;" %>
      </div>


      <div class="information-send">
        <%= form_tag '', id: 'message-form', remote: true do -%>
        <div class="send-msg">
          <%= text_area_tag "message-area" %>
          <%= submit_tag t("view.play.send_msg") %>
        </div>
        <% end -%>
      </div>
    </div>

    <div class="message-con">
      <div class="message-new affiche" id="notice-panel">
      </div>
    </div>

    <div class="message-con">
      <div class="message-new affiche" id="members-panel">
      </div>
    </div>
  </div>
</div>


<%= content_for :mask do %>
<div id="histories" class="message-logging">
  <div class="logging-title">
    <div class="logging-left">
      <i class="glyphicon glyphicon-time"></i>
      <span><%= t("common.message_history") %></span>
    </div>
    <div class="logging-center">
      <span class="glyphicon glyphicon-chevron-left subtract-jedate"></span>
      <input type="text" class="workinput wicon mr25" id="inpstart" />
      <span class="glyphicon glyphicon-chevron-right add-jedate"></span>
      <label for="inpstart" class="glyphicon glyphicon-calendar date-icon"></label>
    </div>

    <div class="logging-right">
      <%= link_to "", "javascript: void(o);", id: "history-close", class: "fa fa-times" %>
    </div>
  </div>

  <div class="logging-more" id="logging-more"><%= t("view.play.more") %></div>
  <div class="logging-nomore" id="logging-nomore"><%= t("view.play.nomore") %></div>

  <div class="message-con active" id="messages-group">
  </div>
</div>
<% end %>

<%= content_for :javascript do %>
<script>
var chatInited = false;

function chatInitCallback() {
  chatInited = true;
  visit();
};

function visit(){
  var team_id = "<%= @chat_team.try(:team_id) %>";
  var params = {
    acc_id: "<%= @chat_account.try(:accid) %>",
    token: $("#online_token").val()
  }
  $.get('/chat/teams/' + team_id + '/member_visit', params,function(data){
    if(data == 'nothing'){
      console.log(data);
    }else{
      $("#members-panel").html(data);
    }
  });
}
visit();
setInterval(visit,30000);

<% if @current_lesson %>
  setInterval(function(){
    $.getScript( "refresh_current_lesson", function( data, textStatus, jqxhr ) {});
  }, 1 * 60 * 1000);
<% end %>

$(function() {
  var accid = "<%= @chat_account.try(:accid) %>";
  var token = "<%= @chat_account.try(:token) %>";
  var team_role = "<%= @join_record.try(:role) %>";
  var chat_team_id = "<%= @chat_team.try(:team_id) %>";
  var owner_id = "<%= @chat_team.try(:owner) %>";

  // 关闭页面前提示
  $( window ).bind( "beforeunload", function() {
    return "是否离开直播页面";
  });

  window.live_chat = new LiveChat("<%= Chat::IM.app_key %>");

  if(accid == "" || chat_team_id == "" || team_role == "") {
    $.getJSON("<%= chat.finish_live_studio_course_teams_path(@course) %>", function(data) {
      accid = data.accid;
      token = data.token;
      chat_team_id = data.team_id;
      owner_id = data.owner;
      live_chat.config(accid, token, chat_team_id);
      live_chat.init(chatInitCallback);
    });
  } else {
    live_chat.config(accid, token, chat_team_id, owner_id);
    live_chat.init(chatInitCallback);
  }

  // 聊天表情
  $("#emotion-btn").qqFace({ assign: "message-area", path: "<%= asset_path('assets/face/') %>" });


  // 历史消息
  $('#history-btn').click(function(event) {
    $("#histories").show();
    var lastMsgId = $("#messages-group div:first").attr("last-msg-id");
    messageHistory($("#inpstart").val(), lastMsgId);
  });

  $("#history-close").click(function() {
    $("#histories").hide();
  });

  // 加载更多历史消息
  $("#logging-more").click(function() {
    var lastMsgId = $("#messages-group div:first").attr("last-msg-id");
    messageHistory($("#inpstart").val(), lastMsgId);
  });

  $("#history-area").scroll(function() {
    if(!$(this).hasClass( "loading" ) && time_str != 0){
      if ($("#history-area").scrollTop() < 150){
        appendHistoryMsgs(event,time_str,1);
      }
    }
  });

  function appendHistoryMsgs(event,end_time,type) {
    if(!chatInited) return false;
    $("#history-area").addClass("loading")
    if (type == 0) $("#history-area").empty();
    var msg = live_chat.nim.getHistoryMsgs({
      scene: 'team',
      to: live_chat.teamId,
      endTime: end_time,
      asc: true,
      limit: 20,
      done: getHistoryMsgsDone
    });

    if (type == 0) {
      var scrolled = false;
      function updateScroll(){
        if(!scrolled){
          var element = document.getElementById("history-area");
          element.scrollTop = element.scrollHeight;
        }
      }
      $("#history-area").on('scroll', function(){
        scrolled=true;
      });
      window.setInterval(updateScroll);
    }
  }

  function getHistoryMsgsDone(error, obj) {
    console.log('获取p2p历史消息' + (!error ? '成功' : '失败'));
    console.log(obj.msgs);
    if (!error) {
      $("#messages-group div:first").attr("last-msg-id", obj.lastMsgId).empty();
      obj.msgs.forEach(function(msg){
        if(msg.type != "notification"){
          var messageNode = $("<div class='new-information'></div>");
          var messageTitle = $("<div class='information-title'></div>");
          messageTitle.append("<img src='" + $("#member-icons").find("img.icon-" + msg.from).attr("src") + "' />");

          if(msg.from != accid){ 
            messageTitle.append("<span class='information-name'>" + msg.fromNick + "</span>");
          }
          messageTitle.append("<span class='information-time'>" + sendMessageTime(msg) + "</span>");
          messageNode.append(messageTitle);

          if(msg.from == accid){
            messageNode.addClass("new-information-stu");
          } else if(msg.from != owner_id) {
            messageNode.addClass("new-information-else");
          }
          messageNode.append("<div class='information-con'>" + $.replaceChatMsg(msg.text) + "</div>");
          $("#messages-group div:first").append(messageNode);

        }
      });
      if(obj.msgs.length >= 100) {
        // 加载更多消息按钮
        $("#logging-more").show();
      } else {
        // 没有更多消息
        $("#logging-nomore").show();
      }
    }
  }

  function messageHistory(messageDate, lastMsgId) {
    messageDate = messageDate.replace(/年/, '-').replace(/月/, '-').replace(/日/, '');
    beginTime = new Date(messageDate + " 00:00:00").getTime();
    endTime = beginTime + 24 * 60 * 60 * 1000;
    // 聊天窗口群组没有初始化不能加载聊天新记录
    if(!chatInited) return false;
    // 显示加载状态
    var historyParams = {
      scene: 'team',
      to: live_chat.teamId,
      beginTime: beginTime,
      endTime: endTime,
      asc: true,
      done: getHistoryMsgsDone
    }

    // 第一次加载清空数据
    if(lastMsgId) {
      // historyParams.lastMsgId = lastMsgId;
    } else {
      $("#messages-group").empty();
    }
    $("#logging-more").hide();
    $("#logging-nomore").hide();
    $("#messages-group").prepend("<div class='logging-con'><center>加载中......</center></div>");
    live_chat.nim.getHistoryMsgs(historyParams);
  }


  // 日历插件

  var start = {
    skinCell:"jedatered",
    clearRestore:false,
    format: 'YYYY年MM月DD',
    minDate: '2016-06-11 00:00:00', //设定最小日期为当前日期
    isinitVal:true,
    isClear:false, 
    festival:false,
    ishmsVal:false,
    maxDate: '2099-06-30 23:59:59', //最大日期
    choosefun: function() {
      // 加载当天数据
      messageHistory($("#inpstart").val());
    }
  };

  $('#inpstart').jeDate(start);

  function addByTransDate(dateParameter, num) {
    var translateDate = "", dateString = "", monthString = "", dayString = "";
    translateDate = dateParameter.replace("年", "/").replace("月", "/");
    var newDate = new Date(translateDate);
    newDate = newDate.valueOf();
    newDate = newDate + num * 24 * 60 * 60 * 1000;
    newDate = new Date(newDate);
    //如果月份长度少于2，则前加 0 补位  
    if ((newDate.getMonth() + 1).toString().length == 1) {
      monthString = 0 + "" + (newDate.getMonth() + 1).toString();
    } else {
      monthString = (newDate.getMonth() + 1).toString();
    }
    //如果天数长度少于2，则前加 0 补位  
    if (newDate.getDate().toString().length == 1) {
      dayString = 0 + "" + newDate.getDate().toString();
    } else {
      dayString = newDate.getDate().toString();
    }
    dateString = newDate.getFullYear() + "年" + monthString + "月" + dayString;
    return dateString;
  }
   
  function reduceByTransDate(dateParameter, num) {
  
    var translateDate = "", dateString = "", monthString = "", dayString = "";
    translateDate = dateParameter.replace("年", "/").replace("月", "/");
    var newDate = new Date(translateDate);
    newDate = newDate.valueOf();
    newDate = newDate - num * 24 * 60 * 60 * 1000;
    newDate = new Date(newDate);
    //如果月份长度少于2，则前加 0 补位  
    if ((newDate.getMonth() + 1).toString().length == 1) {
      monthString = 0 + "" + (newDate.getMonth() + 1).toString();
    } else {
      monthString = (newDate.getMonth() + 1).toString();
    }
    //如果天数长度少于2，则前加 0 补位  
    if (newDate.getDate().toString().length == 1) {
      dayString = 0 + "" + newDate.getDate().toString();
    } else {
      dayString = newDate.getDate().toString();
    }
    dateString = newDate.getFullYear() + "年" + monthString + "月" + dayString;
    return dateString;
  }
 
  //得到日期  主方法
  function showTime(pdVal) {
    var trans_day = "";
    var cur_date = new Date($("#inpstart").val().replace("年", "/").replace("月", "/"));
    var cur_year = new Date($("#inpstart").val().replace("年", "/").replace("月", "/")).getFullYear();
    var cur_month = cur_date.getMonth() + 1;
    var real_date = cur_date.getDate();
    cur_month = cur_month > 9 ? cur_month : ("0" + cur_month);
    real_date = real_date > 9 ? real_date : ("0" + real_date);
    eT = cur_year + "年" + cur_month + "月" + real_date;
    if (pdVal == 1) {
      trans_day = addByTransDate(eT, 1);
    }
    else if (pdVal == -1) {
      trans_day = reduceByTransDate(eT, 1);
    }
    else {
      trans_day = eT;
    }
   //处理
    return trans_day;
  }

  function date() {
    tqyt=showTime(-1);
    thyt=showTime(1);
  }
  var tqyt;
  var thyt;
  $(".subtract-jedate").click(function  () {
    date ();
    $("#inpstart").val(tqyt);
    // 加载当天数据
    messageHistory($("#inpstart").val());
  });
  $(".add-jedate").click(function  () {
    date ();
    $("#inpstart").val(thyt);
    // 加载当天数据
    messageHistory($("#inpstart").val());
  });


  $(".logging-title").mousedown(function(){
    var abs_x = event.clientX - $('.message-logging').offset().left;
    var abs_y = event.clientY - $('.message-logging').offset().top;
    $(document).mousemove(function (e) {
      var xPos = (e.clientX - abs_x)  + "px";
      var yPos = (e.clientY - abs_y) + "px";
      $(".message-logging").css("left", xPos);  
      $(".message-logging").css("top", yPos);  
    }); 
  });

  $(document).mouseup(function(){
    $(document).unbind('mousemove');
  });

});
</script>
<% end %>