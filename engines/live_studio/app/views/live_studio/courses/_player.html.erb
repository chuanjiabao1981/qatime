<div class="row">
  <div class="video-area" id="player-and-chat">
    <div class="area-left">
      <div class="area-left-title">
        <span><%= @course.name %></span>
  					<span>
              <%= image_tag('person-1.png') %>
              <i id="team_online_count">0</i>
  					</span>
      </div>


      <div class="area-left-con">
        <video id="my-video" style="overflow: hidden;" class="video-js"  x-webkit-airplay="allow" webkit-playsinline controls poster="<%= image_url 'big_loading.png' %>" preload="auto" width="" height="" data-setup="{}">
        </video>
      </div>
    </div>
        
    <div class="area-right">

      <div class="area-right-title">
        <%= link_to welcome_download_path, target: '_blank' do %>
          <%= image_tag('download.png') %>
          <span><%= t('view.tips.download') %></span>
        <% end %>
      </div>


      <div class="area-right-con">
        <video id="small-video" class="video-js"  x-webkit-airplay="allow" webkit-playsinline controls poster="<%= image_url 'small_loading.png' %>" preload="auto" width="" height="" data-setup="{}">
        </video>

      </div>
      <%= render 'play_chat' %>
    </div>
  </div>

  <div id="no-flash-area" style="display: none;">
    <p align="center">
      <%= t("activerecord.view.flash_can_not_call_msg.flash_uninstall_or_too_old_msg") %>
      <%= link_to t("activerecord.view.flash_can_not_call_msg.click_here_msg"), "https://get.adobe.com/cn/flashplayer/"  %>
      <%= t("activerecord.view.flash_can_not_call_msg.install_flash_msg") %>
    </p>
  </div>
</div>


<%= content_for :javascript do %>
<script>
$(function() {
  var boardPlayer, cameraPlayer;
  var timer = null;
  var cameraStream = '<%= @course.camera_pull_stream("http") %>';
  var boardStream = '<%= @course.board_pull_stream("http") %>';
  var initStatus = 0;
  var liveStatusStep = '<%= LiveStudio::Lesson.beat_step.to_i * 3 * 1000 %>';

  // 立即播放
  function playNow(player, url) {
    var lowUrl = url.toLowerCase(),
        urlType = lowUrl.substring(0, 4),
        type;
    if (url === '') return;
    switch (urlType) {
      case 'http':
        if (lowUrl.indexOf('mp4') !== -1) {
            type = 'video/mp4';
        } else if (lowUrl.indexOf('flv') !== -1) {
            type = 'video/x-flv';
        } else if (lowUrl.indexOf('m3u8') !== -1) {
            type = 'application/x-mpegURL';
        }
        break;
      case 'rtmp':
        type = 'rtmp/flv';
        break;
    }
    player.setDataSource({ type: type, src: url });
    player.play();
  }

  function playerStatus() {
    console.log("get status " + initStatus);

    if(initStatus <= 1) return false;
    $.get("<%= live_studio.live_status_course_path(@course) %>", function (data) {
      console.log(data);
      if (data['board'] == 1 && boardPlayer.getPlayState() != 1) {
        console.log("start play board");
        playNow(boardPlayer, boardStream);
      }
      if (data['camera'] == 1 && cameraPlayer.getPlayState() != 1) {
        console.log("start play camera");
        playNow(cameraPlayer, cameraStream);
      }
      if( data['board'] == 1 && data['camera'] == 1){
        clearInterval(timer);
        timer = null;
      }
    });
  }

  // 刷新按钮
  var Component = neplayer.getComponent("Component");
  var RefreshComponent = neplayer.extend(Component, {
    createEl: function(){
      var button = document.createElement("button");
      button.className = "vjs-refresh-control vjs-control vjs-button vjs-playing";
      button.innerHTML = '<%= image_tag "refresh.png" %>';
      return button;
    }
  });

  var refreshComponent = new RefreshComponent();

  refreshComponent.on("click",function(){
    if(boardPlayer) boardPlayer.refresh();
    if(cameraPlayer) cameraPlayer.refresh();
  });
  // 刷新按钮结束

  // 弹幕按钮
  var BarrageComponent = neplayer.extend(Component, {
    createEl: function(){
      var button = document.createElement("button");
      button.className = "vjs-barrage-control vjs-control vjs-button vjs-playing";
      button.innerHTML = '<%= image_tag "barrage.png", id: "barrage-btn" %>';
      return button;
    }
  });

  var barrageComponent = new BarrageComponent();
  var barrage = new Barrage("my-video");
  barrageComponent.on("click",function(){
    if(barrage.active) {
      barrage.turnOff();
      $("#barrage-btn").attr("src", '<%= image_url "barrage-ban.png" %>');
    } else {
      barrage.turnOn();
      $("#barrage-btn").attr("src", '<%= image_url "barrage.png" %>');
    }
  });

  // 弹幕按钮结束

  function addButton() {
    // 弹幕按钮
    if(window.live_chat) live_chat.setBarrage(barrage);
    boardPlayer.corePlayer.controlBar.addChild(barrageComponent, {}, 2);
    // 添加刷新按钮
    boardPlayer.corePlayer.controlBar.addChild(refreshComponent, {}, 1);
  }

  // 初始化白板
  function initBoard() {
    // 白板播放器
    boardPlayer = neplayer("my-video", {
      bigPlayButton: false,
      controlBar: {
        progressControl: false,
        liveDisplay: false,
        remainingTimeDisplay: false
      }
    }, function() {
      addButton();
      initStatus = initStatus + 1;
      console.log("board init end " + initStatus);
      playerStatus();
    });
  }

  // 初始化摄像头
  function initCamera() {
    // 摄像头
    cameraPlayer = neplayer("small-video", {
      bigPlayButton: false,
      controlBar: false
    }, function() {
      initStatus = initStatus + 1;
      console.log("camera init end " + initStatus);
      playerStatus();
    });
  }

  // 设置定时查询任务
  function setTimer() {
    if(timer === null) {
      timer = setInterval(playerStatus, liveStatusStep);
    }
  }

  //判断flash是否安装
  if(flashChecker().f) {
    // 初始化白板
    initBoard();
    // 初始化摄像头
    initCamera();
    // 白板结束直播
    boardPlayer.onPlayState(3, function(){
      setTimer();
    });
    boardPlayer.onError(function(error){
      console.log(error.errCode);
    });

    // 摄像头结束直播
    cameraPlayer.onPlayState(3, function(){
      setTimer();
    });
    cameraPlayer.onError(function(error){
      console.log(error.errCode);
    });;
    // 初始化设置定时器
    setTimer();
  } else{
    $("#player-and-chat").hide();
    $("#no-flash-area").show() //提示div
  }
});
</script>

<% end %>