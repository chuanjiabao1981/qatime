<div class="qa_box">
  <div class="qa_cell">
    <div id="audio_reply" style="display:none">
      语音回复
    </div>

    <div id="wechat_record_area" style="display:none">
      <div id="record_wechat_voice" class="btn btn-primary" style="width:75%;float:left;">
        按住录音
      </div>

      <div id="audition" class="btn btn-primary" style="width:20%;float:right;">
        试听
      </div>

    </div>

    <div id="fileList" class="uploader-list">
    </div>

    <div class="message_form">
      <%= form_tag customized_course_messaging_index_path(@customized_course), multipart: true, id: 'message_submit_form' do  %>
          <div id="text-message-area">
            <label for="content-area">留言内容</label>
            <input type="text" id="content-area" name="text_message_content"/>
          </div>
          <input id="message-type" name="message_type" type="hidden" value="text_message"/>

          <div id="preview-area">

          </div>

        <%= submit_tag '提交', id: 'message_submit_form_button'%>
      <% end %>

      <div id="uploader-demo">
        <div id="filePicker">选择图片</div>
      </div>
    </div>

  </div>
</div>
<script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<%= wechat_config_js debug: false, api: %w(hideMenuItems closeWindow uploadVoice startRecord stopRecord onVoiceRecordEnd playVoice pauseVoice stopVoice onVoicePlayEnd downloadVoice) -%>
<script>
  var replyVoice = false;
  var localId = null;
  var serverMediaId = null;
  var recording = false;
  var audition = false;

  // 初始化Web Uploader
  var uploader = WebUploader.create({

    // 选完文件后，是否自动上传。
    auto: false,
    fileNumLimit: 10,
    // swf文件路径
    swf: '/assets/Uploader.swf',

    // 文件接收服务端。
    server: '<%= upload_image_customized_course_messaging_index_path(@customized_course) %>',

    // 选择文件的按钮。可选。
    // 内部根据当前运行是创建，可能是input元素，也可能是flash.
    pick: '#filePicker',

    // 只允许选择图片文件。
    accept: {
      title: 'Images',
      extensions: 'gif,jpg,jpeg,bmp,png',
      mimeTypes: 'image/*'
    },

  });

  uploader.on( 'fileQueued', function( file ) {
    var $li = $(
            '<div id="' + file.id + '" class="file-item thumbnail">' +
            '<img>' +
            '<div class="info">' + file.name + '</div>' +
            '</div>'
        ),
        $img = $li.find('img');


    // $list为容器jQuery实例
    $('#preview-area').append( $li );

    // 创建缩略图
    // 如果为非图片文件，可以不用调用此方法。
    // thumbnailWidth x thumbnailHeight 为 100 x 100
    uploader.makeThumb( file, function( error, src ) {
      if ( error ) {
        $img.replaceWith('<span>不能预览</span>');
        return;
      }

      $img.attr( 'src', src );
    }, '100', '100' );
  });

  uploader.on('uploadBeforeSend', function( object, data, headers) {
    //拓展HTTP头部
    $.extend(headers, {
      'X-CSRF-Token': $('meta[name="csrf-token"]').attr('content')
    });
  });

  var imageUploaded = false;
  var submitForm = false;

  $("#message_submit_form").submit(function (e) {
    if(submitForm){
      return true;
    }
    //点击提交表单事件
    e.preventDefault();
    var $_form = $(this);
    //检查是否上传图片
    if(uploader.getFiles().length > 0){
      var success_nums = 0;
      var image_nums = uploader.getFiles().length;

      uploader.on('uploadSuccess', function (file, response) {
        success_nums += 1;

        //插入图片ID
        $('<input>').attr({
          type: 'hidden',
          name: 'image_ids[]',
          value: response.id
        }).appendTo($_form);

        //如果所有图片都上传完成
        if(success_nums == image_nums){
          $('#message-type').val('image_message');
          submitForm = true;
          $_form.trigger('submit');
        }
      });
      uploader.upload();
    }else if(!!localId) {
      //如果是语音回复 需要添加参数到表单
      var $form = $('#message_submit_form');
      wx.uploadVoice({
        localId: localId, // 需要上传的音频的本地ID，由stopRecord接口获得
        isShowProgressTips: 1, // 默认为1，显示进度提示
        success: function (res) {
          serverMediaId = res.serverId; // 返回音频的服务器端ID
          $('#message-type').val('wechat_voice_message');
          var input = $("<input>")
              .attr("type", "hidden")
              .attr("name", "media_id").val(serverMediaId);
          $form.append($(input));
          submitForm = true;
          $_form.trigger('submit');
        }
      });
    }else{
      //没有图片上传也没有语音消息 默认文字消息
      submitForm = true;
      $_form.trigger('submit');
    }

  });



  wx.ready(function(){
    $("#audio_reply").show();
    $("#audio_reply").click(function(){
      $('.customized_course_message_reply_content').toggle('fast', function(){
        replyVoice = !replyVoice;
        if(replyVoice){
          $("#text-message-area").hide();
          $("#uploader-demo").hide();
        }else{
          $("#audio_reply").text('语音回复');
          $("#text-message-area").show();
          $("#uploader-demo").show();
        }
      });
      $('#wechat_record_area').toggle('fast');
    });

    var stopRecord = function(){
      wx.stopRecord({
        success: function (res) {
          recording = false;
          localId = res.localId;
          console.log('停止录音');
        }
      });
    };

    $('#stop').click(function(){
      stopRecord();
    });

    $('#record_wechat_voice').bind('touchstart', function(){
      console.log('开始录音');
      if(recording){
        stopRecord();
        return;
      }
      recording = true;
      wx.startRecord();
    }).bind('touchend', function(){
      stopRecord();
    });

    $('#audition').click(function(){
      if(audition){
        //正在播放 点击停止
        if(!!localId){
          wx.stopVoice({
            localId: localId
          });
          $('#audition').text('试听');
        }
      }else{
        if(!!localId){
          $('#audition').text('停止');
          wx.playVoice({localId: localId});
        }
      }
    });

    wx.onVoicePlayEnd({
      success: function (res) {
        $('#audition').text('试听');
      }
    });

    $('.unconvert-voice').each(function(index){
      $this = $(this);
      var media_id = $this.data('media-id');
      $this.text('点击播放');
      $this.click(function(){
        wx.downloadVoice({
          serverId: media_id, // 需要下载的音频的服务器端ID，由uploadVoice接口获得
          isShowProgressTips: 1, // 默认为1，显示进度提示
          success: function (res) {
            var thislocalId = res.localId; // 返回音频的本地ID
            wx.playVoice({
              localId: thislocalId
            });
          }
        });
      });
    });
  });
</script>
